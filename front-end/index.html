
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Example</title>
    <!-- D3.js library -->
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>

    <style>
        svg {
          font: 10px sans-serif;
        }
        .line {
          fill: none;
          stroke: #000;
          stroke-width: 1.5px;
        }
        .line2 {
            fill: none;
            stroke: #b70e0a;
            stroke-width: 1.5px;
        }
        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }
    </style>
</head>

<body>

    <button id="wbConnection">Websocket connection</button>
    <button id="wbClose">Websocket close</button>

    <script>


        // -------------------------------------------------------------------
        //          WEBSOCKETS
        // -------------------------------------------------------------------

        // Conexión mediante websocket
        var wsCost = null

        // Boton de conexión al websocket --> Función
        document.getElementById('wbConnection').addEventListener('click', wbConnectionFunc);
        document.getElementById('wbClose').addEventListener('click', wbCloseFunc);

        function wbConnectionFunc(){

            console.log('Trying to connect to socket');

            wsCost= new WebSocket('ws://localhost:7080/v2/broker/?topics=cost');
                wsCost.onopen    = wsCostOpen;
                wsCost.onerror   = wsErrorFunc;
                wsCost.onmessage = wsCostMsg;
        }

        function wbCloseFunc(){
            console.log('Closing WebSocket');
            wsCost.close();
        }

        // Apertura del socket
        var wsCostOpen = function () {
            console.log('Centroids: Connection is open at ', new Date());
        };
        // Error en el socket
        var wsErrorFunc = function (error) {
            console.log('WebSocket Error ', error);
        };
        // Log messages from the server
        var wsCostMsg = function (e) {
            console.log('Server cost: ', e.data, ' at ', new Date());
            var cost = ( JSON.parse( JSON.parse(e.data).message ) );
            tick( cost );

            console.log( cost)
        };


        var n = 10,
            data  = new Array( n ).fill(0),
            data2 = new Array( n ).fill(0);

        var margin = {top: 20, right: 20, bottom: 20, left: 40},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .domain([0, n - 1])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([-1, 2000])
            .range([height, 0]);

        var line = d3.svg.line()
            .x(function(d, i) { return x(i); })
            .y(function(d, i) { return y(d); });

        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.append("defs").append("clipPath")
            .attr("id", "clip")
          .append("rect")
            .attr("width", width)
            .attr("height", height);


        var xaxis = d3.svg.axis().scale(x).orient("bottom");

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + y(0) + ")")
            .call( xaxis );

        var yaxis = d3.svg.axis().scale(y).orient("left");

        svg.append("g")
            .attr("class", "y axis")
            .call( yaxis );

        var path = svg.append("g")
            .attr("clip-path", "url(#clip)")
          .append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line);

        var path2 = svg.append("g")
                .attr("clip-path", "url(#clip)")
                .append("path")
                .datum(data2)
                .attr("class", "line2")
                .attr("d", line);

        //tick();

        function tick( newP ) {

          // push a new data point onto the back
          data.push( newP[0] );
          data2.push( newP[1] )

            y.domain( [0.9*d3.min(data.concat(data2)), 1.1*d3.max(data.concat(data2))])
            svg.select(".y.axis").transition().duration(100).call(yaxis);

          // redraw the line, and slide it to the left
          path
              .attr("d", line)
              .attr("transform", null)
            .transition()
              .duration(100)
              .ease("linear")
              .attr("transform", "translate(" + x(-1) + ",0)");

            path2
            .attr("d", line)
            .attr("transform", null)
            .transition()
            .duration(100)
            .ease("linear")
            .attr("transform", "translate(" + x(-1) + ",0)")            ;

          // pop the old data point off the front
            data.shift();
            data2.shift();

        }

    </script>

</body>
</html>
